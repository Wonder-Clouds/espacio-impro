name: Deploy to VPS (espacio-impro)

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo "ğŸ”„ Entrando al directorio del proyecto"
            cd ~/espacio-impro

            echo "ğŸ“¥ Haciendo pull de la rama main"
            git pull origin main --no-rebase

            echo "ğŸ§¹ Limpiando imÃ¡genes antiguas"
            podman images --format "{{.Repository}} {{.ID}} {{.CreatedAt}}" | grep espacio-impro \
              | sort -rk3 | tail -n +2 | awk '{print $2}' | xargs -r podman rmi -f

            echo "ğŸ§¹ Limpiando imÃ¡genes dangling (<none>)"
            podman images -f "dangling=true" -q | xargs -r podman rmi -f

            echo "ğŸ›‘ Deteniendo contenedor anterior"
            podman-compose stop espacio-impro || true

            echo "âš™ï¸ Construyendo imagen actualizada"
            podman-compose build espacio-impro

            echo "ğŸš€ Levantando servicio espacio-impro"
            podman-compose up -d espacio-impro

            echo "âœ… Despliegue finalizado correctamente"
